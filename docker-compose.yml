version: '3.8'

services:
  # API Service
  docforge-api:
    image: docforge-api
    build:
      context: .
      dockerfile: Dockerfile
    container_name: docforge-api
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ConnectionStrings__DefaultConnection=${DATABASE_CONNECTION_STRING:-Data Source=/app/data/documentgenerator.db}
      - JwtSettings__Secret=${JWT_SECRET:?JWT_SECRET is required - copy .env.example to .env}
      - JwtSettings__Issuer=${JWT_ISSUER:-DocForge}
      - JwtSettings__Audience=${JWT_AUDIENCE:-DocForge}
      - JwtSettings__ExpirationMinutes=${JWT_EXPIRATION_MINUTES:-60}
    volumes:
      - ./data:/app/data
      - ./GeneratedDocuments:/app/GeneratedDocuments
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - docforge-network

  # Frontend Service (Build-time only)
  docforge-frontend-builder:
    image: node:18-alpine
    container_name: docforge-frontend-builder
    volumes:
      - ./DocumentGenerator.Client:/app
      - ./frontend-dist:/app/dist
    working_dir: /app
    command: >
      sh -c "
        if [ ! -d node_modules ]; then
          echo 'Installing frontend dependencies...' &&
          npm ci --silent
        fi &&
        echo 'Building frontend...' &&
        npm run build &&
        echo 'Frontend build completed'
      "
    networks:
      - docforge-network
    profiles:
      - build

  # Nginx Reverse Proxy (Serves both API and Frontend)
  docforge-web:
    image: nginx:alpine
    container_name: docforge-web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend-dist:/usr/share/nginx/html:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - docforge-api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - docforge-network

networks:
  docforge-network:
    driver: bridge

volumes:
  data:
    driver: local
  GeneratedDocuments:
    driver: local
  frontend-dist:
    driver: local
